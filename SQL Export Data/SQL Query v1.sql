USE Forward; DROP TABLE IF EXISTS #pageQueryResults CREATE TABLE #pageQueryResults (DatabasePrefix VARCHAR(MAX), PageNum VARCHAR(10), UserID VARCHAR(MAX), LastActivityDate DATETIME, SurveyStatus INT, PostalCode VARCHAR(20)); DROP TABLE IF EXISTS #pageDataFull CREATE TABLE #pageDataFull (DatabasePrefix VARCHAR(MAX), PageNum VARCHAR(10), UserID VARCHAR(MAX), LastActivityDate DATETIME, SurveyStatus INT, PostalCode VARCHAR(20)); DECLARE @currentTableName varchar(max) = ''; DECLARE @currentTableNameShort varchar(max) = ''; DECLARE @currentPageNum INT; DECLARE @currentPhaseStatus varchar(max) = ''; DECLARE @currentDatabasePrefix varchar(max) = ''; DECLARE @sql varchar(max) = ''; DECLARE tableListCursor CURSOR FOR SELECT DISTINCT pj.Name + '.dbo.' + ph.DatabasePrefix + '_' + CASE WHEN s.SectionTypeId = 5 THEN 'pgDrug' ELSE 'pg' + CAST(p.PageNumber as VARCHAR(3)) END AS 'PageTable', ph.DatabasePrefix + '_' + CASE WHEN s.SectionTypeId = 5 THEN 'pgDrug' ELSE 'pg' + CAST(p.PageNumber as VARCHAR(3)) END as 'TableName', ph.DatabasePrefix, p.PageNumber, nsr.ColumnTitle as 'PhaseStatus' FROM Forward.dbo.Phase ph JOIN Forward.dbo.Project pj ON pj.ProjectId = ph.ProjectId JOIN Forward.dbo.Page p ON p.SurveyToolId = ph.SurveyToolId JOIN Forward.dbo.Section s ON s.PageId = p.PageId JOIN ProjectCategories pc on pj.ProjectId = pc.ProjectId JOIN ProjectCategory pcc on pc.ProjectCategoryId = pcc.ProjectCategoryId JOIN NatalogSurveyReference nsr on nsr.NatalogSurveyReferenceId = ph.NatalogSurveyReferenceId WHERE pj.ProjectId = (SELECT ProjectId FROM Forward.dbo.Project WHERE Name = 'Dupuytrens') ORDER BY p.PageNumber; OPEN tableListCursor; FETCH NEXT FROM tableListCursor INTO @currentTableName, @currentTableNameShort, @currentDatabasePrefix, @currentPageNum, @currentPhaseStatus; WHILE @@FETCH_STATUS = 0 BEGIN SET @sql = N'WITH pageQuery AS (SELECT q.GUID as ' + QUOTENAME('UserID') + ', q.Date as ' + QUOTENAME('LastActivityDate') + ', n.' + @currentPhaseStatus + ' as ' + QUOTENAME('SurveyStatus') + ', n.zip as ' + QUOTENAME('PostalCode') + 'FROM ' + @currentTableName + ' q JOIN arc.dbo.Natalog n ON q.guid = n.guid) INSERT INTO #pageQueryResults (UserID, LastActivityDate, SurveyStatus, PostalCode) SELECT UserID, LastActivityDate, SurveyStatus, PostalCode FROM pageQuery'; EXEC(@sql); WITH pageDataFullQuery AS (SELECT @currentDatabasePrefix AS 'DatabasePrefixVar', 'pg' + CASE WHEN @currentPageNum > 9 THEN CAST(@currentPageNum AS VARCHAR(3)) ELSE '0' + CAST(@currentPageNum AS VARCHAR(3)) END as 'PageNumber', pqr.UserID, pqr.LastActivityDate, pqr.SurveyStatus, pqr.PostalCode FROM #pageQueryResults pqr) INSERT INTO #pageDataFull (DatabasePrefix, PageNum, UserID, LastActivityDate, SurveyStatus, PostalCode) SELECT * FROM pageDataFullQuery DELETE FROM #pageQueryResults FETCH NEXT FROM tableListCursor INTO @currentTableName, @currentTableNameShort, @currentDatabasePrefix, @currentPageNum, @currentPhaseStatus; END CLOSE tableListCursor; DEALLOCATE tableListCursor; DROP TABLE IF EXISTS #pageDataFinal CREATE TABLE #pageDataFinal (UserID VARCHAR(MAX), PostalCode VARCHAR(20), DatabasePrefix VARCHAR(MAX), pg01_SurveyStatus INT, pg01_LastActivityDate DATETIME, pg02_SurveyStatus INT, pg02_LastActivityDate DATETIME, pg03_SurveyStatus INT, pg03_LastActivityDate DATETIME, pg04_SurveyStatus INT, pg04_LastActivityDate DATETIME, pg05_SurveyStatus INT, pg05_LastActivityDate DATETIME, pg06_SurveyStatus INT, pg06_LastActivityDate DATETIME, pg07_SurveyStatus INT, pg07_LastActivityDate DATETIME, pg08_SurveyStatus INT, pg08_LastActivityDate DATETIME, pg09_SurveyStatus INT, pg09_LastActivityDate DATETIME, pg10_SurveyStatus INT, pg10_LastActivityDate DATETIME, pg11_SurveyStatus INT, pg11_LastActivityDate DATETIME, pg12_SurveyStatus INT, pg12_LastActivityDate DATETIME, pg13_SurveyStatus INT, pg13_LastActivityDate DATETIME, pg14_SurveyStatus INT, pg14_LastActivityDate DATETIME, pg15_SurveyStatus INT, pg15_LastActivityDate DATETIME, pg16_SurveyStatus INT, pg16_LastActivityDate DATETIME, pg17_SurveyStatus INT, pg17_LastActivityDate DATETIME, pg18_SurveyStatus INT, pg18_LastActivityDate DATETIME, pg19_SurveyStatus INT, pg19_LastActivityDate DATETIME, pg20_SurveyStatus INT, pg20_LastActivityDate DATETIME, pg21_SurveyStatus INT, pg21_LastActivityDate DATETIME, pg22_SurveyStatus INT, pg22_LastActivityDate DATETIME, pg23_SurveyStatus INT, pg23_LastActivityDate DATETIME, pg24_SurveyStatus INT, pg24_LastActivityDate DATETIME); INSERT INTO #pageDataFinal SELECT pdfss.UserID, pdfss.PostalCode AS 'PostalCode', pdfss.DatabasePrefix, pdfss.pg01 AS 'pg01_SurveyStatus', pdflad.pg01 AS 'pg01_LastActivityDate', pdfss.pg02 AS 'pg02_SurveyStatus', pdflad.pg02 AS 'pg02_LastActivityDate', pdfss.pg03 AS 'pg03_SurveyStatus', pdflad.pg03 AS 'pg03_LastActivityDate', pdfss.pg04 AS 'pg04_SurveyStatus', pdflad.pg04 AS 'pg04_LastActivityDate', pdfss.pg05 AS 'pg05_SurveyStatus', pdflad.pg05 AS 'pg05_LastActivityDate', pdfss.pg06 AS 'pg06_SurveyStatus', pdflad.pg06 AS 'pg06_LastActivityDate', pdfss.pg07 AS 'pg07_SurveyStatus', pdflad.pg07 AS 'pg07_LastActivityDate', pdfss.pg08 AS 'pg08_SurveyStatus', pdflad.pg08 AS 'pg08_LastActivityDate', pdfss.pg09 AS 'pg09_SurveyStatus', pdflad.pg09 AS 'pg09_LastActivityDate', pdfss.pg10 AS 'pg10_SurveyStatus', pdflad.pg10 AS 'pg10_LastActivityDate', pdfss.pg11 AS 'pg11_SurveyStatus', pdflad.pg11 AS 'pg11_LastActivityDate', pdfss.pg12 AS 'pg12_SurveyStatus', pdflad.pg12 AS 'pg12_LastActivityDate', pdfss.pg13 AS 'pg13_SurveyStatus', pdflad.pg13 AS 'pg13_LastActivityDate', pdfss.pg14 AS 'pg14_SurveyStatus', pdflad.pg14 AS 'pg14_LastActivityDate', pdfss.pg15 AS 'pg15_SurveyStatus', pdflad.pg15 AS 'pg15_LastActivityDate', pdfss.pg16 AS 'pg16_SurveyStatus', pdflad.pg16 AS 'pg16_LastActivityDate', pdfss.pg17 AS 'pg17_SurveyStatus', pdflad.pg17 AS 'pg17_LastActivityDate', pdfss.pg18 AS 'pg18_SurveyStatus', pdflad.pg18 AS 'pg18_LastActivityDate', pdfss.pg19 AS 'pg19_SurveyStatus', pdflad.pg19 AS 'pg19_LastActivityDate', pdfss.pg20 AS 'pg20_SurveyStatus', pdflad.pg20 AS 'pg20_LastActivityDate', pdfss.pg21 AS 'pg21_SurveyStatus', pdflad.pg21 AS 'pg21_LastActivityDate', pdfss.pg22 AS 'pg22_SurveyStatus', pdflad.pg22 AS 'pg22_LastActivityDate', pdfss.pg23 AS 'pg23_SurveyStatus', pdflad.pg23 AS 'pg23_LastActivityDate', pdfss.pg24 AS 'pg24_SurveyStatus', pdflad.pg24 AS 'pg24_LastActivityDate' FROM (SELECT DatabasePrefix, UserID, MAX(PostalCode) AS 'PostalCode', MAX(pg01) AS 'pg01', MAX(pg02) AS 'pg02', MAX(pg03) AS 'pg03', MAX(pg04) AS 'pg04', MAX(pg05) AS 'pg05', MAX(pg06) AS 'pg06', MAX(pg07) AS 'pg07', MAX(pg08) AS 'pg08', MAX(pg09) AS 'pg09', MAX(pg10) AS 'pg10', MAX(pg11) AS 'pg11', MAX(pg12) AS 'pg12', MAX(pg13) AS 'pg13', MAX(pg14) AS 'pg14', MAX(pg15) AS 'pg15', MAX(pg16) AS 'pg16', MAX(pg17) AS 'pg17', MAX(pg18) AS 'pg18', MAX(pg19) AS 'pg19', MAX(pg20) AS 'pg20', MAX(pg21) AS 'pg21', MAX(pg22) AS 'pg22', MAX(pg23) AS 'pg23', MAX(pg24) AS 'pg24' FROM (SELECT * FROM #pageDataFull PIVOT (MAX(SurveyStatus) FOR PageNum IN (pg01,pg02,pg03,pg04,pg05,pg06,pg07,pg08,pg09,pg10,pg11,pg12,pg13,pg14,pg15,pg16,pg17,pg18,pg19,pg20,pg21,pg22,pg23,pg24)) AS pageDataFullPivot) pdfss_pre GROUP BY DatabasePrefix, UserID) pdfss JOIN (SELECT * FROM #pageDataFull PIVOT (MAX(LastActivityDate) FOR PageNum IN (pg01,pg02,pg03,pg04,pg05,pg06,pg07,pg08,pg09,pg10,pg11,pg12,pg13,pg14,pg15,pg16,pg17,pg18,pg19,pg20,pg21,pg22,pg23,pg24)) AS pageDataFullPivot) pdflad ON pdfss.UserID = pdflad.UserID AND pdfss.DatabasePrefix = pdflad.DatabasePrefix ORDER BY UserID, DatabasePrefix SELECT * FROM #pageDataFinal